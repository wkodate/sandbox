システムセキュリティ
===

## ポイント

#### 理解しておきたい用語と概念

* パケットフィルタリング
* ProFTPD
* vsftpd
* Pure-FTPD
* 匿名FTP
* OpenSSH
* ポートスキャン
* セキュリティスキル
* TCP Wrapperとlibwrap
* OpenVPN

#### 習得しておきたい技術

* iptablesによるパケットフィルタリング設定
* IP転送
* OpenSSHの設定
* OpenSSHの認証の仕組み
* SSHを使ったポート転送
* OpenSSHのセキュリティ
* 開いているポートの確認
* TCP Wrapperの設定
* OpenVPNの設定

## ルータを構成する

### パケットフィルタリング

* パケットの情報からパケットを通過させたり遮断したりする
* チェイン
    * パケットを検査するための一連のルールセット
* テーブル
    * チェインのまとまり

### iptablesコマンド

* チェイン、ターゲット、ルール、オプションを設定できる
* 書式
    * `iptables -[AD] チェイン ルール`
    * `iptables -P チェイン ターゲット`
    * `iptables -[LFNX] [チェイン]`
    * `iptables -I チェイン [ルール番号] ルール`
* オプション
    * `-P` 指定したチェインのポリシー(デフォルトターゲット)を変更
    * `-A` チェインにルールを追加
    * `-D` チェインにルールを削除
    * `-N` チェインを作成
    * `-L` チェインのルールを一覧表示
    * `-F` チェイン内のルールを全て削除
    * `-X` 空のユーザ独自のチェインを削除
* チェイン
    * パケットの処理方法を定義したルール群
    * `INPUT` ホストに入ってくるパケット
    * `OUTPUT` ローカルマシンで生成されたパケット
    * `FORWARD` ホストを経由するパケット
    * `PREROUTING` 入ってきたパケットを変換
    * `POSTROUTING` 出ていくパケットを変換
* ターゲット
    * `ACCEPT`
        * 通過を許可
    * `DROP`
        * 破棄
* ルール
    * `-s IPアドレス` 
        * 送信元のIPアドレスの指定
    * `-d IPアドレス`
        * 送信先のIPアドレスの指定
    * `--sport ポート番号`
        * 送信元のポート番号
    * `--dport ポート番号`
        * 送信先のポート番号
    * `-j` ターゲットを指定
* iptables-saveコマンド
    * iptablesの現在の設定をファイルに保存
    * リダイレクト「>」で保存
* iptables-restoreコマンド
    * iptablesの設定をファイルから復元する
    * 標準入力でファウルを渡す

### IPv6

* IPv6ではip6tablesコマンドを使う
* アドレス範囲
    * ループバックアドレス
        * IPv6: `::1/128` 
        * IPv4: `127.0.0.0/8`
    * リンクローカルアドレス(ユニキャスト)
        * IPv6: `fe80::/10`
        * IPv4: リンクローカルアドレス
    * ユニークローカルアドレス(ユニキャスト)
        * IPv6: `fc00::/7`
        * IPv4: (プライベートアドレス)
    * グローバルアドレス(ユニキャスト)
        * IPv6: `2000::3`
        * IPv4: グローバルアドレス
    * マルチキャストアドレス
        * IPv6: `ff00::/8`
        * IPv4: `224.0.0.0/4`

### ルーティングテーブル

* パケット転送を処理するルールが書かれたテーブル
* routedデーモン
* ルーティングテーブルの表示
    * route コマンド
    * netstat -r コマンド
* IPマスカレード
    * プライベートIPアドレスとグローバルIPアドレスのアドレス変換

## FTPサーバの管理

* FTPサーバの種類
    * wu-ftpd
        * 古くからUNIX系OSで利用されている
    * ProFTPD
        * 設定が用意
    * vsftpd
        * 高い安全性
    * Pure-FTPD
        * セキュリティと実用性を重視
* /etc/ftpusers
    * アクセス制御で許可しないユーザを記述
* パッシブモードとアクティブモード
    * パッシブモード
        * データ転送用ポートの接続要求をクライアント側から行う
    * アクティブモード
        * データ転送用ポートの接続要求をサーバ側から行う

### ProFTPDの設定

* proftpd.conf
* Apacheの設定に似ている

### vsftpdの設定

* vsftpd.conf
    * `anon_upload_enable = YES | NO`
        * 匿名ユーザによるアップロードを許可
* ftp_username
    * 匿名ユーザを設定
    * デフォルトはftp

### Pure-FTPD

* pure-ftpd.conf
* pure-ftpdコマンド
    * 起動時にオプションを使用して動作を指定
    * オプション
        * `-E` 匿名ユーザによるログインを禁止
        * `-e` 匿名ユーザのみログインを許可

### 匿名FTPサーバ

* wu-ftpd
    * 匿名FTPサービスを利用する場合には、chrootを使ってセキュリティを高める

### chroot

プロセスによってのルートディレクトリを指定したディレクトリに変更することで、プロセスがシステム全体へのアクセスをできないように閉じ込めた環境

## セキュアシェル

### OpenSSH

* LinuxのSSHの実装で利用されている
* SSHサーバの機能はsshdデーモンにより提供
    * sshdの設定ファイルは`/etc/ssh/sshd_config`
    * 設定項目
        * `PasswordAuthentication`
            * パスワード認証を許可するかを指定
            * デフォルトはyes
        * `PermitRootLogin`
            * rootユーザのsshログインを許可するかを指定
        * `PubkeyAuthentication`
            * SSHプロトコルバージョン2で公開鍵認証を許可するかを指定
        * `X11Forwarding`
            * X11転送を許可するかを指定
            * デフォルトはno
        * `AllowUsers|DenyUsers`
            * ログインを許可/禁止するユーザ
        * `AllowGroups|DenyGroups`
            * ログインを許可/禁止するユーザ
* sshポートフォワーディング
    * あるポートに送られてきたTCPパケットをSSHを使ってリモートホストの任意のポートに転送
    * 書式
        * `ssh -L 転送対象ポート番号:SSHサーバから見た接続先アドレス:SSHサーバからの接続先ポート番号 [SSH接続ユーザー名@]SSHサーバアドレス`

### ホスト認証とユーザ認証

* ユーザ認証の前に接続先ホストの正当性を確認する認証
* 公開鍵暗号方式でホストの正当性を確認
* SSHサーバの秘密鍵と公開鍵(/etc/ssh配下)
    * v1 RSA
        * `ssh_host_key`
        * `ssh_host_key.pub`
    * v2 RSA
        * `ssh_host_rsa_key`
        * `ssh_host_rsa_key.pub`
    * v2 DSA
        * `ssh_host_dsa_key`
        * `ssh_host_dsa_key.pub`
* ユーザの秘密鍵と公開鍵(~/.ssh/配下)
    * v1 RSA
        * `identity`
        * `identity.pub`
    * v2 RSA
        * `id_rsa`
        * `id_rsa.pub`
    * v2 DSA
        * `id_dsa`
        * `id_dsa.pub`
    * 作成した公開鍵はあらかじめサーバの「~/.ssh/authorized_keys」ふぁいるに登録しておく

### 公開鍵認証

* 公開鍵暗号方式を使ってユーザ認証をする
* 公開鍵認証の手順
    * あらかじめサーバ側に公開鍵を登録
    * SSH接続時に公開鍵が利用できるかの確認
    * クライアント側は公開鍵にユーザ名等のデータを加え、秘密鍵で署名してサーバ側に送信される
    * サーバ側ではユーザの公開鍵を使って署名を確認する
    * 確認できればログインを許可

* ssh-agent
    * SSHのクライアント側で稼働するデーモン
    * パスフレーズ入力を省略できる
* SSHサーバのセキュリティ
    * SSHバージョン1の利用禁止
    * パスワード認証の禁止
    * rootログイン禁止
    * ログインユーザの制限
    * 接続元の制限

## セキュリティ業務

### セキュリティツール
* Snort
    * ネットワークインターフェース上のトラフィックを監視し、攻撃や侵入を捕えるIDS
* Tripwire
    * ファイルシステムの状況を記録しておくことでファイルの改竄を検知するプログラム
* OpenVAS
    * オープンソースのセキュリティスキャナでネットワーク経由で脆弱性のチェックができるツール
* Fail2ban
    * ログファイルを監視して攻撃を検知し、攻撃元のIPアドレスを遮断するソフトウェア
    * フィルタとアクションを組み合わせ、アクションの発動条件を指定

### ポートスキャン

* 開いてるポート表示のコマンド
    * nmap
    * netstat -atun
    * ss -atun
    * lsof -i -n
    * fuser -v -n tcp 22
* nmap
    * 書式
        * `nmap [スキャンタイプ] [オプション] ターゲット`
    * スキャンタイプ
        * `-sS` 
            * TCP SYNスキャン
        * `-sT`
            * TCP connect()スキャン
            * システムコールを使いユーザ権限で動作するTCPスキャン
        * `-sU`
            * UDPスキャン
    * オプション
        * `-p ポート番号` スキャンするポート番号の指定


### TCP Wrapper

* アクセス制御を集中的に管理する仕組み
* /etc/hosts.allow, /etc/hosts.deny

### セキュリティ情報

* セキュリティの情報源
    * CERT/CC
        * セキュリティインシデントの受付、発生状況の把握、技術支援を行っている組織
    * CIAC
        * セキュリティインシデントに関する報告を行っている期間
    * Bugtraq
        * ソフトウェアのバグ情報を公開するためのメーリングリスト
* セキュリティ侵害への対応
    * 攻撃
        * 主なコマンドの改ざん
        * ログの改ざんやsyslogの停止
        * 悪意のあるソフトウェア(malware)の導入と使用

## OpenVPN

* VPN
    * Virtual Private Network
    * インターネットを介して専用回線で接続されているかのようにプライベートなネットワークを構築する技術
* OpenVPN
    * LinuxでVPNを利用するのに使われるソフトウェア
    * PKIを利用する
* OpenVPNサーバの設定ファイル
    * /etc/openvpn/server.conf
* OpenVPNクライアントの設定ファイル
    * /etc/openvpn/client.conf
    * 主な設定
        * nobind
            * クライアント側のポート番号を自動割り当てする



