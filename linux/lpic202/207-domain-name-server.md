ドメインネームサーバ
===

## ポイント

#### 理解しておきたい用語と概念

* DNS
* ゾーン
* /etc/named.conf
* ゾーンファイルとレコード
* ゾーン転送
* chroot
* DNSSEC
* TSIG
* DANE

#### 習得しておきたい技術

* /etc/named.confの設定
* ゾーンファイルの設定
* 名前解決コマンド
* rndcコマンド
* BINDのセキュリティ
* dnssec-keygenコマンド
* dnssec-signzoneコマンド

## DNSの基本

DNSサーバ

* DNSサーバソフトウェアとして、BINDをがよく利用される。サーバデーモンはnamed
* ゾーン
    * DNSサーバが管轄するドメインの範囲
    * 権威
        * ゾーンを管理できる権限を持っていること
    * 移譲
        * 下位のDNSサーバに管理を移すこと
* マスタースレーブ
    * マスター
        * ゾーンファイルを所有するDNSサーバ
    * スレーブ
        * マスターのゾーン情報をコピーするDNSサーバ
    * ゾーン転送
        * マスターからスレーブへのコピー
* 問い合わせを下位のDNSサーバに再起的に行う

DNSサーバソフトウェア

* BIND
    * Berkeley Internet Name Domain
    * 代表的なDNSサーバでありLinuxで利用される
    * namedデーモンが起動
* dnsmasq
    * DNSサーバとDHCPサーバの機能を提供するソフトウェア
* djbdns
    * 機能を分割して安全性を高めたDNSサーバ
* PowerDNS
    * コンテンツサーバおよびキャッシュサーバ機能を提供するソフトウェア
    * MySQL, RDBをバックエンドデータベースとして利用できる

クライアントコマンド

* host
    * 名前解決の結果のみを完結に表示
    * `-t` リソースレコードタイプを指定
* nslookup
    * 現在は非推奨で後継はdig
    * 対話モードでも問い合わせができる
* dig
    * Domain Information Grouper
    * 名前解決の詳細を表示。クエリを発行し得られた応答を出力して詳細を表示
    * 回答はヘッダ+4つのセクション+フッタ
    * ヘッダ
        * digコマンドの実行結果そのものに関する情報
    * QUESTION SECION
        * 問い合わせ内容
    * ANSWER SECTION
        * 問い合わせに対する回答
    * AUTHORITY SECTION
        * 問い合わせ先に権威がある場合に表示
    * ADDITIONAL SECTION
        * 回答したホストのIPアドレスなどの付帯情報
    * フッタ
        * Query time
            * 検索に要した時間
        * SERVER
            * 回答したホストのIPアドレスとポート番号
        * WHEN
            * 問い合わせ日時
        * MSG SIZE rcvd
            * メッセージサイズ

## BINDの基本設定

BINDの設定はメイン設定ファイル/etc/named.confとゾーンファイルから構成される

/etc/named.conf

* いくつかのステートメントとオプションから構成される
* ステートメントはセミコロンで終わる。ステートメント内のサブステートメントもセミコロンで終わる
* aclステートメント
    * ACLの定義
* controlsステートメント
    * rndcコマンドの使用を許可するホストを指定
* includeステートメント
    * 外部ファイルの読み込み
* keyステートメント
    * 認証情報の設定
* zoneステートメント
    * ゾーンの定義。ゾーンファイル名を指定する
    * 「masterfile-format text;」を指定すると、テキスト形式でゾーンデータを扱えるようになる(パフォーマンスは悪くなる)
* optionsステートメント
    * namedの動作に関する詳細設定
    * ゾーンファイルに配置するディレクトリを指定
    * directory
        * namedの作業ディレクトリを指定
    * recursion
        * 再起問い合わせを受け付けるかの設定
    * recursive-clients
    * max-cache-size
    * forward [only|first]
        * 問い合わせ転送の失敗時の動作を設定
        * first 失敗時に自分で問い合わせする
        * only 失敗時に自分で問い合わせしない
    * forwarders
        * 自身が保持しないドメイン情報の問い合わせを転送するDNSサーバのアドレスを指定
    * allow-query
        * 問い合わせを受け付けるホストを指定
    * allow-recursion
        * 再起問い合わせを受け付けるホストを指定
    * allow-transfer
        * ゾーン転送を許可するホストを指定
    * version
        * BINDのバージョンの問い合わせに対し、出力される文字列を設定
* named-checkconf
    * named.confの構文チェック

rndcコマンド

* remote named daemon control
* namedを操作できるコマンド
* サブコマンド
    * status
        * namedのステータスを表示する
    * reload
    * halt
        * namedを直ちに停止
    * stop
        * 動的な更新等を保存してからnamedを停止

## ゾーンファイルの管理

ゾーンに関する情報は、ゾーンごとにゾーンファイルに記述する

ゾーンファイルの構成

* $ORIGINディレクティブ
    * ドメイン名が明示されていないレコードで補完するドメインを指定
* $TTLディレクティブ
    * 他のDNSサーバがゾーンデータをキャッシュの保存しておく時間を指定
* リソースレコード
    * ゾーンの情報を記述

リソースレコード

* タイプ
    * SOAレコード
        * Start of Authority
        * 管理情報
        * リソースレコードの最初に記載
        * 書式
            * ＜ドメイン＞ IN SOA ＜ネームサーバのFQDN＞ ＜管理者のメールアドレス＞ (各更新時間に関する秒数を定義）
        * @はドメイン名を表す
    * NSレコード
        * Name Server
        * ゾーンを管理するDNSサーバ
    * MXレコード
        * Mail Exchange
        * メールサーバを記述
    * Aレコード
        * ホスト名に対応するIPアドレスを定義
    * AAAAレコード
    * CNAMEレコード
    * PTRレコード
        * IPアドレスに対応する名前(FQDN)を記述。主に逆引きゾーンの定義に使用
* named-checkzoneコマンド
    * ゾーンファイルの構文チェック、整合性チェックを行う
* named-compilezoneコマンド
    * 内容をテキスト形式に変換


## DNSサーバのセキュリティ

一般的なセキュリティオプション

* ゾーン転送の制限
    * スレーブにだけゾーン情報を転送できるように制限する
* DNS問い合わせの制限
    * 問い合わせの範囲を自分の管理するゾーンに制限
    * 再帰的な問い合わせを禁止することで、不正なキャッシュデータをDNSサーバに送りつけるキャッシュ汚染攻撃を回避できる
* バージョン番号の隠蔽
    * バージョンでセキュリティホール突かれる可能性があるので
* root以外によるnamedの実行
    * 侵入されても被害を最小限に抑えることができる
    * 被害を限定するためにchrootを利用する方法がある
        * あるプロセスのルートディレクトリを指定したディレクトリに変更
        * オプション
            * `-t` namedのルートディレクトリとするディレクトリを指定
            * `-u` namedの実行ユーザを指定
            * `-g` namedの実行グループを指定

DNSSEC

* DNS Security
* ゾーン情報に公開鍵暗号方式の電子署名を行い、ゾーン情報が改ざんされていないこと、DNS応答が正当な管理者によって行われたものであることを保証
* DNSサーバ、クライアントの双方が対応している必要がある

TSIG

* Transaction Signatures
* マスターDNSサーバとスレーブDNSサーバで共有秘密鍵を使ってDNSサーバの偽装やなりすましを防ぐ仕組み
* マスターDNSで共通鍵を使ってゾーンデータに署名し、スレーブDNSサーバでそれを検証する
* dnssec-keygenコマンドで共通鍵を生成
    * -n 鍵のオーナータイプを指定
* /etc/named.confのkeyステートメントに共通鍵を設定、serverステートメントにIPアドレスと共通鍵名を設定
* 不正なクライアントからのrndcコマンドの操作防止

DANE

* DNS-based Authentication of Named Entites
* 認証情報をDNSベースでやりとりするための仕組み
* X509の証明書とDNSの紐付けで認証を行う
