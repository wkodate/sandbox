ファイルシステムとデバイス
===

### Linuxファイルシステムの操作と保守

* ファイルシステムの情報
    * /etc/fstab
        * ファイルシステムのマウントの設定が書かれているファイル
        * デバイス、マウント先、種類、オプション、dumpフラグ、fsckフラグ の書式
        * オプション
            * users 一般ユーザでマウント可、誰でもアンマウント可
    * /etc/mtab
        * 現在のマウント状況を確認するファイル
        * /proc/mountsにも同じ情報がある
    * /proc/filesytems
        * カーネルが利用可能なファイルシステムの一覧が書かれているファイル
* 主なファイルシステムの種類
    * ext2
        * Linuxで標準的に使われる。ジャーナリング機能をもたない。Second Extended Filesystem
    * ext3
        * ext2にジャーナリング機能を加えたもの
    * ext4
        * ext3の後継で、大容量のファイルシステムをサポート
        * RHEL6, Ubuntuのルートファイルシステムタイプ
    * btrfs
        * サブボリューム(subvolume)を構成しスナップショットなどの機能を持つ。従来のファイルシステム+LVM。データの破損も検出、破棄、修復が可能
        * ZFSを参考として開発された
        * btrfs filesystem show コマンドでファイルシステムの情報を表示
    * xfs
        * 古くからあり、ジャーナリング機能を持つ
        * RHEL7及びその派生OS(CentOS, Oracle Linuxなど)のルートファイルシステムタイプ
    * iso9660
        * CDROMで使われる
    * FAT/VFAT
        * フラッシュメモリで利用
    * ntfs
        * 近年のwindowsで利用
    * nfs
        * ネットワークファイルシステム。ネットワークを介したリモートのファイルにアクセス
    * tmpfs
        * メモリ上に配置(RAMディスク)
    * swap
        * 物理メモリのスワップ先
    * ZFS
        * OracleのSolarisで使用
* ext2/ext3ファイルシステムの構造
    * ブロック単位で管理されており、ブロックには、データブロック、iノードブロック、スーパーブロックがある
    * スーパーブロックには、ファイルシステム全般のメタ情報が格納されている
    * ブロックグループでまとめられている
* マウント、アンマウント
    * デバイスとその上に構築されているファイルシステムをOSに認識させ、指定のディレクトリに割当、そのディレクトリ以下のパスでファイルシステム内にアクセスできるようになる
    * mountコマンド
        * オプション指定なしで、現在マウントされているファイルシステムの一覧を表示
        * -t ファイルシステムの種類を指定
    * unmountコマンド
        * -aオプションで/etc/mtab にあるファイルシステムをすべてアンマウント
    * fuser
        * 指定したファイルシステムに対してアクセスを行っているプロセスの一覧を得たり、そのプロセスをすべてkillしたりする動作が可能
* ルートファイルシステムは、ディレクトリのルートとするファイルシステムであり、他のファイルシステムをマウントすることで複数のファイルシステムからなるディレクトリ構造を作り、統一的にアクセス可能にしている
* スワップ領域
    * 物理メモリを超えたデータを退避するためのハードディスク上の領域
    * スワップ領域の有効化手順
        * スワップ領域として使いたいサイズのファイルを作成する
        * mkswapコマンドで、作成したファイルをスワップ領域として初期化する
        * swaponコマンドで、作成したファイルをスワップ領域として有効化する
    * mkswap
        * スワップ領域を作成、初期化
    * dd
        * スワップ領域として利用するファイルを作成
    * swapon
        * スワップ領域を勇往
    * swapon -s, cat /proc/swaps
        * システムで有効になっているスワップ領域の利用状況を調べるコマンド
* パーティション
    * ハードディスクの領域を分割
    * パーティション分割のメリット
        * ファイルのバックアップやシステムのアップデータが必要な場合に便利
        * 障害に強い
        * HDDを有効活用できる
    * パーティション分割のデメリット
        * 見積もりミスによってパーティションの使用率に偏りが発生する(かもしれない)
    * MBR形式とGPT形式がある。MBR形式は、基本パーティションと拡張パーティションがあり、基本パーティションは4つまで作成可能、それ以上分割するには拡張パーティションに割り当てて論理パーティションにする
    * fdisk
        * パーティション操作
    * 新しいハードディスクをLinuxで利用するための流れ
        * パーティションを切る(基本パーティション、拡張パーティションを作成)
        * 各パーティションをフォーマットし、ファイルシステムを作る
        * 作ったファイルシステムをマウント
* SMART
    * ハードディスクの問題を発見するための自己診断機能。Self-Monitoring, Analysis and Reporting Technology System
    * smartdデーモンを実行、smartctlコマンドで監視内容を確認
* blkid
    * デバイスのラベル、UUID、ファイルシステムの種類などを表示するコマンド

### ファイルシステムの作成とオプションの構成

* ファイルシステムを作成するコマンド
    * mke2fs
        * ext2/ext3/ext4を作成するコマンド
        * -j ext3として作成する
        * -b ブロックサイズをbyte単位で指定
    * mkfs.ext2, mkfs.ext3, mkfs.ext4
        * ex2,ex3,ex4のファイルシステムを作成するコマンド
    * mkfs.xfs
        * xfsを作成するコマンド
    * mkfs
        * いろいろなファイルシステムを作ることができる
        * 内部でmkfs.ext2などを呼んでいる
    * mkisofs
        * CD-ROMなどに使われるフォーマット ISO9660 のファイルシステムを作成するコマンド
        * -R Unix系拡張のRockRidgeフォーマットで作成
* ファイルシステムをチェックするコマンド
    * e2fsck
        * ext2/ext3/ext4のチェック
    * xfs_check
        * xfsのチェック
    * fsck
        * いろいろなファイルシステムをチェック
* 作成済みファイルシステムに対するコマンド
    * tune2fs
        * ext2/ext3/ext4の設定を行う
        * -j ext2をext3に変換
        * -L ラベルをつける
    * dumpe2fs
        * ext2/ext3/ext4の詳細を表示する
    * e2label
        * ext2/ext3/ext4のラベルを操作
        * tune2fsの-Lオプションでラベルを付けることもできる
* ジャーナリング
    * 実データをディスクに書き込む前にメタデータを書き込んでおくことで、不正な終了時の不整合を防ぐ機能
    * 手順
        * 書き込みが操作が発生
        * メタデータの更新内容をログに書き込む
        * データとメタデータをディスクに書き込む
        * ディスクへの書き込みが完了したら、該当のログを破棄する
* オートマウント
    * 特定のデバイスを必要なときだけ自動でマウントし、利用できるようにする機能
    * メインの設定ファイル /etc/auto.master
        * ファイルのフィールドは左から順に、マウントポイント、マップファイル、オプション
        * 編集したらautomountデーモンの再起動が必要
        * マップファイルの形式は、マウント名 [マウントオプション] ロケーション(マウントするリソースやデバイス)
* ファイルシステムの暗号化
    * 手順
        * ブロックデバイスへの暗号化マッピングを作成する
        * 暗号化マッピングにファイルシステムを作成する
        * 暗号化ファイルシステムをマウントする
    * dm-crypt
        * ブロックデバイスの暗号化方法のひとつ
        * cryptsetupコマンドで暗号化デバイスを作成、管理する
        * /dev/mapperディレクトリ配下にファイルシステムを作成
    * LUKS(Linux Unified Key Setup)
        * Linuxで標準的に使用される暗号化ファイルシステムの仕様
        * dm-cryptを用いて実装されている
        * 使用手順
            * デバイスをLUKSパーティションとして初期化
            * LUKSパーティションを開く
            * 開いたLUKSパーティションにファイルシステムを作成する
            * 暗号化ファイルシステムをマウントする
