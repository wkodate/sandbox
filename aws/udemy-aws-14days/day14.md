Day14 CloudFormationを用いた環境構築の自動化
==

## やること

* AWSの環境構築自動化サービス群
* CloudFormationについて
* ベストプラクティス

## AWSの環境構築自動化サービス群

* Elastic Beanstalk
    * 定番インフラ構成の自動構築およびAppデプロイの自動化サービス
    * Webサーバ構成
        * ELB + Auto Scaling + EC2
    * Batchワーカ構成
        * SQS + Auto Scaling + EC2
    * メリット
        * アプリ開発にリソースを注力できる
    * デメリット
        * 自由度は低い
* OpsWorks
    * Chefを利用した構成管理サービス
        * EC2上のエージェントがOpsWorks上のChefレシピを参照して自動構築
        * 自前でChef Server/Clientを構築保守しなくて良い
    * メリット
        * Chefをすでに利用している場合に最適
    * デメリット
        * OSより下のレイヤはできない
* CloudFormation
    * AWSのリソース管理・構築を自動化するサービス
        * テンプレートをJSONやYAML形式で記述
        * テンプレートをもとにAWSリソースの自動構築
    * メリット
        * 自由度が高くなんでもできる
    * デメリット
        * OSより上のレイヤはできない

## CloudFormation

* テンプレート
    * AWSのリソースをYAML or JSONで記載したドキュメント
* スタック
    * テンプレートから自動構築されたAWSリソースの集合
* テンプレートの構成
    * セクション
        * Parameters
            * 実行時に埋め込む変数値
        * Mappings
            * 実行環境によって変わる値をMap形式で定義
        * Resources
            * AWSリソース群を定義する
    * 組み込み関数
        * Ref
            * 動的に決まる値を参照するときに使う
        * FindInMap
            * Mappingsで定義された変数を使う
    * 疑似パラメータ
        *  AWS::Region
            * 実行環境に応じて変わる値を使用したいときに使う

## 使ってみる

* 流れ
    * シンプルなテンプレートでVPCを作る
    * Ref関数を使ってサブネットを作る
    * 残りのネットワーク周りを仕上げる
    * EC2の雛形を作る
    * Parametersセクションを使ってEC2インスタンスタイプを実行時に選択できるようにする
    * Parameter + AWS固有パラメータを使い、アカウントにあるキーペアを実行時に選択してEC2に埋め込む
    * MappingセクションとFindInMap関数を使ってリージョン毎のAMIを選択する
    * スタックを削除する

## ベストプラクティス

* 組み込み関数を使って環境に依存しないテンプレートを目指す
* リソース追加・変更は必ずCloudFormationで行う
* テンプレートをバージョン管理する
* システムの規模やライフサイクルによってテンプレートを分割する

